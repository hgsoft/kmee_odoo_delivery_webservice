# -*- coding: utf-8 -*-

import time
import math
from pycorreios import Correios
from openerp.osv import fields,osv
from openerp.tools.translate import _

webservice_type = {
       'pac': Correios().PAC,
       'sedex': Correios().SEDEX,
       'sedex_10': Correios().SEDEX_10,
       'sedex_hoje': Correios().SEDEX_HOJE,
       'e_sedex': Correios().E_SEDEX,
       'ote': Correios().OTE,
       'normal': Correios().NORMAL,
       'sedex_a_cobrar': Correios().SEDEX_A_COBRAR,                       
       }

class delivery_carrier(osv.osv):
    _inherit = "delivery.carrier"

    def name_get(self, cr, uid, ids, context=None):
        if not len(ids):
            return []
        if context is None:
            context = {}
        order_id = context.get('order_id',False)
        if not order_id:
            res = super(delivery_carrier, self).name_get(cr, uid, ids, context=context)
        else:
            order = self.pool.get('sale.order').browse(cr, uid, order_id, context=context)
            currency = order.pricelist_id.currency_id.name or ''
            res = [(r['id'], r['name']+' ('+(str(r['price']))+' '+currency+' '+ str(r['term'])+' dia(s))') for r in self.read(cr, uid, ids, ['name', 'price', 'term'], context)]
        return res
        
    def get_price(self, cr, uid, ids, field_name, arg=None, context=None):
        res = super(delivery_carrier, self).get_price(cr, uid, ids, field_name, arg, context)
        if context is None:
            context = {}
        sale_obj=self.pool.get('sale.order')
        webservice_obj=self.pool.get('delivery.webservice')
        for carrier in self.browse(cr, uid, ids, context=context):
            res[carrier.id] = {
                'price': res[carrier.id],
                'term': 0,
            }
            order_id=context.get('order_id',False)
            if (carrier.webservice_id.service == "Correios"): 
                if order_id:
                    order = sale_obj.browse(cr, uid, order_id, context=context)
                    res[carrier.id]['price'],res[carrier.id]['term'] = webservice_obj.get_price_term(cr, uid, carrier, order, context)
        return res
                            
    _columns = {
       'price' : fields.function(get_price, string='Price', multi="sums"),
       'term' : fields.function(get_price, string='Term', multi="sums"),
       }
    
class delivery_webservice(osv.osv):
    _inherit = "delivery.webservice"


    def get_price_term(self, cr, uid, carrier, order, context=None):
        total = 0
        weight = 0
        volume = 0
        for line in order.order_line:
            if not line.product_id:
                continue
            total += line.price_subtotal or 0.0
            weight += (line.product_id.weight or 0.0) * line.product_uom_qty
            volume += (line.product_id.volume or 0.0) * line.product_uom_qty            

        volume_cm = volume * 100000
        peso_volumetrico = 0
        
        if (volume_cm > 60000):
            peso_volumetrico = math.ceil(volume_cm / 6000)
            
        peso_considerado = max(weight, peso_volumetrico)
        aresta = int(math.ceil(volume_cm**(1/3.0)))
        print peso_considerado, "aQUIIIIIIIIIIIIII33"
        fields = {
                  "cod": webservice_type[carrier.webservice_type],
                  "GOCEP": order.partner_shipping_id.zip,
                  "HERECEP": order.shop_id.company_id.partner_id.zip,
                  "peso": peso_considerado,
                  "formato": "1", # caixa/pacote
                  "comprimento": aresta,
                  "altura": aresta,
                  "largura": aresta,
                  "diametro": "0",
                  "empresa": carrier.webservice_id.login ,
                  "senha": carrier.webservice_id.password,
                  }

        try:
            response = Correios().frete(**fields)
        except Exception:
            raise osv.except_osv(_('Erro no calculo do frete!'),
                                 _('Nao foi possivel conectar'))

        return (float(response['Valor'].replace(",", ".")),response['PrazoEntrega'] or 0.00)
    
